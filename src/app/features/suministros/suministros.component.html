<div class="p-4">
    <h1 class="text-2xl font-bold text-[#006341] mb-4">Agenda Citas</h1>

    <div class="mb-4 grid gap-2 md:grid-cols-2">
        <div>
            <label class="block font-semibold text-sm">Orden de suministro</label>
            <input type="text" [(ngModel)]="ordenDeSuministro" (input)="buscarOrdenDebounced()"
                [disabled]="isEditingIndex !== null" (keydown)="navegarAutocomplete($event)"
                class="w-full border px-2 py-1 rounded" placeholder="Buscar orden..." />

            <!-- Resultados del autocompletado -->
            <ul *ngIf="autocompleteResults.length > 0 && isEditingIndex === null"
                class="border rounded mt-1 bg-white shadow max-h-60 overflow-y-auto">
                <li *ngFor="let result of autocompleteResults; let i = index" (click)="seleccionarOrden(result)"
                    [ngClass]="{
                    'bg-[#CBA135]/20': autocompleteIndex === i,
                    'bg-white': autocompleteIndex !== i
                  }" class="px-3 py-2 hover:bg-[#CBA135]/20 cursor-pointer text-sm border-b last:border-b-0">
                    <strong>{{ result.orden_de_suministro }}</strong> — {{ result.descripcion }}
                    <div class="text-xs text-gray-600">{{ result.unidad }} | {{ result.proveedor }} | {{
                        result.clave_cnis }}</div>
                </li>
            </ul>
        </div>

        <div *ngIf="seleccionActual && isEditingIndex === null" class="space-y-2">
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium">CLUES</label>
                    <input [value]="seleccionActual.clues_destino" readonly
                        class="w-full border px-2 py-1 rounded bg-gray-100" />
                </div>
                <div>
                    <label class="block text-sm font-medium">Unidad</label>
                    <input [value]="seleccionActual.unidad" readonly
                        class="w-full border px-2 py-1 rounded bg-gray-100" />
                </div>
            </div>


            <div>
                <label class="block text-sm font-medium">Proveedor</label>
                <input [value]="seleccionActual.proveedor" readonly
                    class="w-full border px-2 py-1 rounded bg-gray-100" />
            </div>

            <div>
                <label class="block text-sm font-medium">Clave CNIS + Descripción</label>
                <textarea [value]="seleccionActual.clave_cnis + ' - ' + seleccionActual.descripcion" readonly
                    class="w-full border px-2 py-1 rounded bg-gray-100"></textarea>
            </div>

            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-sm font-medium">Tipo de Red</label>
                    <input [value]="seleccionActual.tipo_de_red" readonly
                        class="w-full border px-2 py-1 rounded bg-gray-100" />
                </div>
                <div>
                    <label class="block text-sm font-medium">Cantidad</label>
                    <input [value]="seleccionActual.cantidad" readonly
                        class="w-full border px-2 py-1 rounded bg-gray-100" />
                </div>
                <div>
                    <label class="block text-sm font-medium">Fecha de Cita</label>
                    <input [value]="formatearFecha(seleccionActual.fecha_de_cita)" readonly
                        class="w-full border px-2 py-1 rounded bg-gray-100" />
                </div>
            </div>

        </div>
    </div>

    <!-- Campos adicionales -->
    <div *ngIf="seleccionActual && isEditingIndex === null" class="grid md:grid-cols-2 gap-4 border-t pt-4 mt-4">
        <div>
            <label class="block text-sm font-medium">Tarimas</label>
            <input type="text" [(ngModel)]="filtros.tarimas" class="w-full border px-2 py-1 rounded" />
        </div>
        <div>
            <label class="block text-sm font-medium">Fecha (DD/MM/AAAA)</label>
            <input type="text" [(ngModel)]="filtros.fecha"
                [ngClass]="{'border-red-500': filtros.fecha && !validarFechaInput(filtros.fecha)}"
                placeholder="DD/MM/AAAA" class="w-full border px-2 py-1 rounded" />
            <div *ngIf="filtros.fecha && !validarFechaInput(filtros.fecha)" class="text-red-600 text-xs mt-1">
                Formato inválido. Usa DD/MM/AAAA.
            </div>

        </div>
        <div>
            <label class="block text-sm font-medium">Hora (24h)</label>
            <input type="text" [(ngModel)]="filtros.hora"
                [ngClass]="{'border-red-500': filtros.hora && !validarHoraInput(filtros.hora)}" placeholder="HH:mm"
                class="w-full border px-2 py-1 rounded" />
            <div *ngIf="filtros.hora && !validarHoraInput(filtros.hora)" class="text-red-600 text-xs mt-1">
                Formato inválido. Usa HH:mm en formato 24h.
            </div>

        </div>
        <div>
            <label class="block text-sm font-medium">Cita Atendida</label>
            <select [(ngModel)]="filtros.cita_atendida" class="w-full border px-2 py-1 rounded">
                <option>SI</option>
                <option>NO</option>
                <option>EN PROCESO</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium">Estatus</label>
            <select [(ngModel)]="filtros.estatus_excel" class="w-full border px-2 py-1 rounded">
                <option>Pendiente</option>
                <option>Recibido</option>
            </select>
        </div>
    </div>

    <!-- Botones -->
    <div class="mt-4 flex gap-2 flex-wrap">
        <button (click)="agregarRegistro()" [disabled]="!puedeAgregar() || isEditingIndex !== null"
            class="bg-[#006341] text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Agregar
        </button>

        <button (click)="limpiarFormulario()"
            class="bg-gray-300 px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed"
            [disabled]="isEditingIndex !== null">
            Limpiar Formulario
        </button>

        <button (click)="mostrarModalLimpiar = true"
            [disabled]="registrosCapturados.length === 0 || isEditingIndex !== null"
            class="bg-red-500 text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Limpiar Listado
        </button>

        <button (click)="showModalFinalizar = true"
            [disabled]="registrosCapturados.length === 0 || isEditingIndex !== null"
            class="bg-[#CBA135] text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Finalizar y Exportar
        </button>
    </div>


    <!-- Tabla -->
    <div class="mt-6 overflow-x-auto">
        <table class="min-w-full text-xs border border-gray-300">
            <thead class="bg-[#2E8B57] text-white">
                <tr>
                    <th class="px-2 py-1 border">Orden</th>
                    <th class="px-2 py-1 border">CLUES</th>
                    <th class="px-2 py-1 border">Unidad</th>
                    <th class="px-2 py-1 border">Proveedor</th>
                    <th class="px-2 py-1 border">CNIS</th>
                    <th class="px-2 py-1 border">Descripción</th>
                    <th class="px-2 py-1 border">Red</th>
                    <th class="px-2 py-1 border">Cant</th>
                    <th class="px-2 py-1 border">Tarimas</th>
                    <th class="px-2 py-1 border">Fecha</th>
                    <th class="px-2 py-1 border">Hora</th>
                    <th class="px-2 py-1 border">Atendida</th>
                    <th class="px-2 py-1 border">Estatus</th>
                    <th class="px-2 py-1 border">F. Cita</th>
                    <th class="px-2 py-1 border">#</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let reg of registrosCapturados; let i = index"
                    class="border-b transition-all duration-300 ease-in-out"
                    [class.bg-yellow-100]="isEditingIndex === i"
                    [class.opacity-50]="isEditingIndex !== null && isEditingIndex !== i" [ngClass]="{
    'even:bg-gray-50': true,
    'bg-yellow-200 animate-pulse': highlightedIndex === i
  }">

                    <td class="px-2 py-1 border">{{ reg.orden_de_suministro }}</td>
                    <td class="px-2 py-1 border">{{ reg.clues_destino }}</td>
                    <td class="px-2 py-1 border">{{ reg.unidad }}</td>
                    <td class="px-2 py-1 border">{{ reg.proveedor }}</td>
                    <td class="px-2 py-1 border">{{ reg.clave_cnis }}</td>
                    <td
                        class="border px-2 py-1 break-words max-w-[300px] whitespace-nowrap overflow-hidden text-ellipsis">
                        <span [title]="reg.descripcion">{{ reg.descripcion }}</span>
                    </td>
                    <td class="px-2 py-1 border">{{ reg.tipo_de_red }}</td>
                    <td class="px-2 py-1 border">{{ reg.cantidad }}</td>
                    <td class="px-2 py-1 border">
                        <input *ngIf="isEditingIndex === i" [(ngModel)]="filtrosEdit.tarimas"
                            class="w-full border px-1" />
                        <span *ngIf="isEditingIndex !== i">{{ reg.tarimas }}</span>
                    </td>
                    <td class="border px-2 py-1 whitespace-nowrap">
                        <input *ngIf="isEditingIndex === i" [(ngModel)]="filtrosEdit.fecha"
                            class="border rounded px-2 py-1 w-28"
                            [class.border-red-500]="!validarFechaInput(filtrosEdit.fecha)" placeholder="DD/MM/AAAA" />
                        <span *ngIf="isEditingIndex !== i">{{ formatoDDMMYYYY(reg.fecha) }}</span>
                    </td>
                    <td class="border px-2 py-1 whitespace-nowrap">
                        <input *ngIf="isEditingIndex === i" [(ngModel)]="filtrosEdit.hora"
                            class="border rounded px-2 py-1 w-20"
                            [class.border-red-500]="!validarHoraInput(filtrosEdit.hora)" placeholder="hh:mm" />
                        <span *ngIf="isEditingIndex !== i">{{ reg.hora }}</span>
                    </td>
                    <td class="px-2 py-1 border">
                        <select *ngIf="isEditingIndex === i" [(ngModel)]="filtrosEdit.cita_atendida" class="w-full border px-1">
                            <option>SI</option>
                            <option>NO</option>
                            <option>EN PROCESO</option>
                        </select>
                        <span *ngIf="isEditingIndex !== i">{{ reg.cita_atendida }}</span>
                    </td>
                    <td class="px-2 py-1 border">
                        <select *ngIf="isEditingIndex === i" [(ngModel)]="filtrosEdit.estatus_excel" class="w-full border px-1">
                            <option>Pendiente</option>
                            <option>Recibido</option>
                        </select>
                        <span *ngIf="isEditingIndex !== i">{{ reg.estatus_excel }}</span>
                    </td>
                    <td class="px-2 py-1 border">{{ formatearFecha(reg.fecha_de_cita) }}</td>
                    <td class="border px-2 py-1 whitespace-nowrap">
                        <div class="flex items-center justify-end gap-2">
                            <button *ngIf="isEditingIndex !== i" (click)="editar(i)"
                                class="text-blue-600 hover:underline">✏️</button>
                            <button *ngIf="isEditingIndex === i" (click)="guardarEdicion(i)"
                                class="text-green-600 hover:underline">✅</button>
                            <button *ngIf="isEditingIndex === i" (click)="cancelarEdicion()"
                                class="text-yellow-600 hover:underline">❌</button>
                            <button (click)="eliminar(i)" class="text-red-600 hover:underline">🗑️</button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal para exportar -->
    <div *ngIf="showModalFinalizar" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-[90vw] max-w-xl space-y-4">
            <h2 class="text-lg font-bold">Exportar Excel</h2>

            <div>
                <label class="block text-sm font-medium">Encabezado (celda A1)</label>
                <input type="text" [(ngModel)]="encabezadoExcel" class="w-full border px-2 py-1 rounded" />
            </div>

            <div>
                <label class="block text-sm font-medium">Nombre del archivo</label>
                <input type="text" [(ngModel)]="nombreArchivoExcel" class="w-full border px-2 py-1 rounded" />
            </div>

            <div class="flex justify-end gap-2 pt-2">
                <button (click)="showModalFinalizar = false" class="bg-gray-300 px-4 py-2 rounded">Cancelar</button>
                <button (click)="exportarExcel()" class="bg-[#006341] text-white px-4 py-2 rounded">Descargar</button>
            </div>
        </div>
    </div>

</div>

<!-- Modal reutilizable con Tailwind -->
<app-confirmacion-modal *ngIf="mostrarModalInfo" [mensaje]="mensajeModalInfo" [soloInfo]="true"
    (confirmar)="mostrarModalInfo = false">
</app-confirmacion-modal>

<app-confirmacion-modal *ngIf="mostrarModalLimpiar" mensaje="¿Deseas eliminar todo el listado y limpiar el formulario?"
    (confirmar)="confirmarLimpiarListado()" (cancelar)="mostrarModalLimpiar = false" />