<div class="p-6 space-y-6">
  <h2 class="text-xl font-bold text-green-800">Citas Pendientes o Incompletas</h2>

  <!-- Filtros -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
    <input type="text" [(ngModel)]="filtroBusqueda" (ngModelChange)="actualizarAgrupacion()"
      placeholder="Buscar orden, proveedor, CNIS, descripción"
      class="px-4 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 w-full" />

    <select [(ngModel)]="filtroUnidad" (ngModelChange)="actualizarAgrupacion()"
      class="px-4 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
      <option value="">Todas las unidades</option>
      <option *ngFor="let unidad of unidadesUnicas" [value]="unidad">{{ unidad }}</option>
    </select>

    <app-periodo-picker-dashboard [fechaInicio]="fechaInicio" [fechaFin]="fechaFin"
      [titulo]="'Fecha de Cita'"
      (rangoCambiado)="onPeriodoSeleccionado($event.texto, $event.fechaInicio, $event.fechaFin)">
    </app-periodo-picker-dashboard>

    <div class="flex items-center space-x-2">
      <input type="checkbox" [(ngModel)]="incluirFechasNulas" (change)="actualizarAgrupacion()" id="toggleFechasNulas"
        class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500" />
      <label for="toggleFechasNulas" class="text-sm">Incluir citas sin fecha</label>
    </div>
  </div>

  <!-- Mini estadísticas -->
  <div class="flex flex-col md:flex-row gap-4 mt-6">
    <div class="bg-yellow-100 text-yellow-900 p-4 rounded shadow w-full md:w-1/2">
      <h3 class="font-semibold">Citas vigentes sin agendar</h3>
      <p class="text-2xl">{{ citasSinAgendar.length }}</p>
    </div>
    <div class="bg-red-100 text-red-900 p-4 rounded shadow w-full md:w-1/2">
      <h3 class="font-semibold">Citas agendadas sin recepción</h3>
      <p class="text-2xl">{{ citasAgendadasSinRecepcion.length }}</p>
    </div>
  </div>

  <!-- Acordeones -->
  <div *ngFor="let grupo of unidadesAgrupadas; let i = index" class="border rounded shadow-sm mb-4" #grupoUnidad>
    <button type="button" (click)="toggleUnidad(grupo.unidad)"
      class="w-full text-left p-4 font-semibold bg-green-100 text-green-900 hover:bg-green-200 transition">
      {{ grupo.unidad }} — Total: {{ grupo.citas.length | number }} cita(s)
    </button>

    <div [hidden]="unidadExpandida !== grupo.unidad" class="bg-white">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-left">
          <tr class="renglon-info">
            <th class="p-2 border">Orden</th>
            <th class="p-2 border">Proveedor</th>
            <th class="p-2 border">CLUES</th>
            <th class="p-2 border">Clave CNIS</th>
            <th class="p-2 border">Descripción</th>
            <th class="p-2 border">Fecha de cita</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let cita of grupo.citas"
              (click)="abrirModalDetalle(cita)"
              class="border-t hover:bg-gray-100 cursor-pointer renglon-info">
            <td class="p-2 border">{{ cita.orden_de_suministro }}</td>
            <td class="p-2 border">{{ cita.proveedor }}</td>
            <td class="p-2 border">{{ cita.clues_destino }}</td>
            <td class="p-2 border">{{ cita.clave_cnis }}</td>
            <td class="p-2 border">{{ cita.descripcion }}</td>
            <td class="p-2 border">{{ cita.fecha_de_cita || '—' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<app-detalle-cita-modal 
  [visible]="mostrarModalDetalle"
  [cita]="citaSeleccionada"
  (cerrar)="cerrarModalDetalle()">
</app-detalle-cita-modal>