<div class="p-6 space-y-6 mb-6">
    <h2 class="text-2xl font-bold mb-4 text-green-800">Proveedores y Entregas</h2>

    <!-- Filtros mejorados con distribución flexible -->
    <div class="flex flex-wrap gap-4 items-center">

        <!-- Input de búsqueda -->
        <div class="min-w-[270px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Búsqueda</label>
            <input type="text" placeholder="Buscar proveedor/clave/descripción..." [(ngModel)]="filtroBusqueda"
                (input)="onBusqueda()" (keydown)="onBusqueda()"
                class="flex-1 min-w-[440px] px-4 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" />
        </div>

        <!-- Select de unidad -->
        <div class="min-w-[270px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Unidades</label>
            <select [(ngModel)]="filtroUnidad" (change)="onBusqueda()"
                class="flex-1 min-w-[220px] px-4 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                <option value="">Todas las unidades</option>
                <option *ngFor="let unidad of unidadesUnicas" [value]="unidad">{{ unidad }}</option>
            </select>
        </div>

        <!-- Picker de periodo -->
        <div class="min-w-[270px]">
            <app-periodo-picker-dashboard [fechaInicio]="fechaInicio" [fechaFin]="fechaFin"
                [titulo]="'Fecha de Recepción'"
                (rangoCambiado)="onPeriodoSeleccionado($event.texto, $event.fechaInicio, $event.fechaFin)">
            </app-periodo-picker-dashboard>
        </div>

        <!-- Etiqueta resumen -->
        <div class="text-sm text-gray-600 text-right min-w-[180px]">
            {{ proveedoresAgrupados.length }} proveedor(es).
        </div>
    </div>


    <!-- Acordeones -->
    <div *ngFor="let grupo of proveedoresAgrupados; let i = index" class="mb-4 border rounded shadow-sm scroll-mt-24"
        #grupoRef>
        <button type="button" (click)="toggleProveedor(grupo.proveedor, i)"
            class="w-full text-left p-4 font-semibold bg-green-100 text-green-900 hover:bg-green-200 transition">
            @let totalPiezasPorProveedor = getTotalPiezasPorProveedor(grupo.citas);

            {{ grupo.proveedor }} — Total: {{ totalPiezasPorProveedor | number }} piezas
        </button>

        <div [hidden]="proveedorExpandido !== grupo.proveedor" class="bg-white">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-left">
                    <tr>
                        <th class="p-2 border">Orden</th>
                        <th class="p-2 border">CLUES</th>
                        <th class="p-2 border">Unidad</th>
                        <th class="p-2 border">Clave CNIS</th>
                        <th class="p-2 border">Descripción</th>
                        <th class="p-2 border">Piezas</th>
                        <th class="p-2 border">Fecha recepción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let cita of grupo.citas" (click)="abrirModalDetalle(cita)"
                        class="border-t hover:bg-gray-100 cursor-pointer">
                        <td class="p-2 border">{{ cita.orden_de_suministro }}</td>
                        <td class="p-2 border">{{ cita.clues_destino }}</td>
                        <td class="p-2 border">{{ cita.unidad }}</td>
                        <td class="p-2 border">{{ cita.clave_cnis }}</td>
                        <td class="p-2 border">{{ cita.descripcion }}</td>
                        <td class="p-2 border text-right">{{ cita.pzas_recibidas_por_la_entidad || 0 }}</td>
                        <td class="p-2 border">{{ cita.fecha_recepcion_almacen }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Agregar un espacio en blanco al final para dar espacio al footer -->
    <div class="mb-40">
        <!-- separador -->
        <hr>
    </div>
</div>

<app-detalle-cita-modal [visible]="mostrarModalDetalle" [cita]="citaSeleccionada" (cerrar)="cerrarModalDetalle()">
</app-detalle-cita-modal>