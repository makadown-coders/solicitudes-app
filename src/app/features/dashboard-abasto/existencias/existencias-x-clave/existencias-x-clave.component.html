<div class="flex flex-col items-start gap-4 md:flex-row">
  <!-- Columna izquierda -->
  <div class="flex flex-col gap-4 w-full md:w-1/2">
    <!-- Chip clave seleccionada -->
    <div class="flex-1">
      <label *ngIf="!claveConfirmada" class="block mb-1 text-sm font-medium text-gray-700">Buscar clave:</label>

      <!-- Input visible si NO hay clave confirmada -->
      <div *ngIf="!claveConfirmada" class="relative">
        <input type="text" [(ngModel)]="claveBusqueda" (input)="searchSubject.next(claveBusqueda)"
          (keydown)="onInputKeyDown($event)" placeholder="Buscar clave (mínimo 3 caracteres)"
          class="px-3 py-2 w-full border-gray-300 rounded-md shadow-sm border focus:ring focus:outline-none" />

        <ul *ngIf="autocompleteResults.length"
          class="overflow-auto z-10 absolute top-12 left-0 right-0 max-h-52 bg-white shadow-md border rounded">
          <li *ngFor="let item of autocompleteResults; let i = index" [class.bg-gray-200]="i === selectedIndex"
            (click)="selectClave(item)" class="p-2 cursor-pointer hover:bg-gray-200">
            {{ item.clave }} - {{ item.descripcion }} ({{ item.presentacion || item.unidadMedida || 'Sin unidad' }})
          </li>
          <li *ngIf="moreResults && autocompleteResults.length < totalResults" class="p-2 text-sm text-gray-500">
            Mostrando {{ autocompleteResults.length }} de {{ totalResults }} resultados...
          </li>
        </ul>
      </div>
      <div *ngIf="claveConfirmada"
        class="flex items-start gap-3 px-3 py-2 bg-green-50 border-green-200 rounded-md border">
        <lucide-icon [img]="pillIcon" class="mt-1 w-5 h-5 text-green-700"></lucide-icon>
        <div class="flex-1 text-sm">
          <p class="font-semibold text-green-800">{{ claveFiltrada }}</p>
          <p class="text-gray-700">{{ descripcion }}</p>
          <p class="text-sm">{{ unidad }}</p>
          <button (click)="reiniciarBusquedaClave()" class="text-sm text-blue-600 underline hover:text-blue-800">
            Cambiar
          </button>
        </div>
        <div class="flex-1 text-sm">
          @let esControlado = claveEsControlado(claveFiltrada);
          <p *ngIf="esControlado" class="text-red-700"> Medicamento Controlado </p>
          <p class="text-sm"> <strong>Clasif. VEN:</strong> {{ clasificacion }}</p>
          @if (citaParaDescripcionDeClave)
          {
          <p class="text-sm">
            <strong>Tipo de Insumo:</strong> {{ citaParaDescripcionDeClave.tipo_de_insumo }}
          </p>
          <p class="text-sm">
            <strong> Grupo Terapéutico: </strong> {{citaParaDescripcionDeClave.grupo_terapeutico }}
          </p>
          <p class="text-sm">
            <strong> Tipo de Red: </strong>{{ citaParaDescripcionDeClave.tipo_de_red }}
          </p>
          <p class="text-sm"> - aqui tambien se mostraria una lista de claves alternativas - </p>
          }
        </div>
      </div>
    </div>

    <!-- Tabla órdenes halladas -->
    <div *ngIf="claveFiltrada && this.citasHalladasPorClave.length > 0" class="flex-1 flex flex-col gap-4">
      <div class="overflow-auto p-4 h-full bg-white border rounded shadow">
        <h3 class="mb-2 text-base font-semibold text-green-800">Ordenes halladas para la Clave</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm shadow-sm border rounded">
            <thead class="text-gray-700 text-left bg-gray-100 border-b">
              <tr>
                <th class="px-2 py-1">Orden</th>
                <th class="px-2 py-1">Contrato</th>
                <th class="px-2 py-1">Procedimiento</th>
                <th class="px-2 py-1">Tipo Entrega</th>
                <th class="px-2 py-1">Unidad</th>
                <th class="px-2 py-1">Fte_Fmto</th>
                <th class="px-2 py-1">Compra</th>
                <th class="px-2 py-1 text-right">Pzas Emitidas</th>
                <th class="px-2 py-1">F. Emisión</th>
                <th class="px-2 py-1">F. Límite</th>
                <th class="px-2 py-1">F. Cita</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cita of citasHalladasPorClave" class="border-t hover:bg-gray-50">
                <td class="px-2 py-1">{{ cita.orden_de_suministro }}</td>
                <td class="px-2 py-1">{{ cita.contrato }}</td>
                <td class="px-2 py-1">{{ cita.procedimiento }}</td>
                <td class="px-2 py-1">{{ cita.tipo_de_entrega }}</td>
                <td class="px-2 py-1">{{ cita.unidad }}</td>
                <td class="px-2 py-1">{{ cita.fte_fmto }}</td>
                <td class="px-2 py-1">{{ cita.compra }}</td>
                <td class="px-2 py-1 text-right">{{ cita.no_de_piezas_emitidas }}</td>
                <td class="px-2 py-1">{{ cita.fecha_emision | date:'dd/MM/yyyy' }}</td>
                
                  @let fleVencida = esVencida(cita.fecha_limite_de_entrega);
                  @let fleHoy = esHoy(cita.fecha_limite_de_entrega);
                  @let fleProxima = esProxima(cita.fecha_limite_de_entrega);
                  @let colorFlecha = fleVencida ? 'text-red-700 font-bold' :
                  (fleHoy ? 'text-green-700 font-bold' : (fleProxima ? 'text-yellow-700 font-bold' : ''));
                  @let fleTitle = fleVencida ? 'Fecha Límite Vencida' :
                  (fleHoy ? 'Fecha Límite Hoy' : (fleProxima ? 'Próxima Fecha' : ''));
                
                <td class="px-2 py-1" [ngClass]="colorFlecha" [attr.title]="fleTitle">

                  {{ cita.fecha_limite_de_entrega | date:'dd/MM/yyyy' }}

                </td>

                @let fdcVencida = esVencida(cita.fecha_de_cita!);
                @let fdcHoy = esHoy(cita.fecha_de_cita!);
                @let fdcProxima = esProxima(cita.fecha_de_cita!);
                @let colorFdc = fdcVencida ? 'text-red-700 font-bold' :
                (fdcHoy ? 'text-green-700 font-bold' : (fdcProxima ? 'text-yellow-700 font-bold' : ''));
                @let fdcTitle = fdcVencida ? 'Fecha Cita Vencida' :
                (fdcHoy ? 'Fecha Cita Hoy' : (fdcProxima ? 'Próxima Fecha' : ''));

                <td class="px-2 py-1" [ngClass]="colorFdc" [attr.title]="fdcTitle">
                  {{ cita.fecha_de_cita ? (cita.fecha_de_cita | date:'dd/MM/yyyy') : 'Sin fecha' }}

                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Columna derecha -->
  <div class="flex flex-col gap-4 w-full md:w-1/2">
    <div *ngIf="claveFiltrada" class="border rounded shadow">
      <!-- Sección por almacén -->
      <div *ngFor="let almacen of datosAgrupados" class="flex items-center m-6 border rounded">
        <h2 class="ml-2 mb-1 text-base font-bold text-green-800">{{ almacen.almacen | titlecase }}</h2>
        <p class="mb-2 text-sm text-gray-600 text-center">Existencia en Almacén:
          @let totalExistencia = totalExistenciaEnAlmacen(almacen.almacen);
          <span class="font-semibold">{{ totalExistencia }}</span>
        </p>

        <!-- Tabla por unidad -->
        <table class="overflow-hidden w-full text-sm shadow-sm border rounded">
          <thead class="text-gray-600 bg-gray-100 border-b">
            <tr>
              <th class="px-2 py-1 text-left">Unidad</th>
              <th class="px-2 py-1 text-right">CPM</th>
              <th class="px-2 py-1 text-right">Existencia</th>
              <th class="px-2 py-1 text-right">P. Reorden</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let unidad of almacen.unidades" class="border-t">
              <td class="px-2 py-1">{{ unidad.unidad }}</td>
              <td class="px-2 py-1 text-right">{{ unidad.clave.cpm }}</td>
              <td class="px-2 py-1 text-right">{{ unidad.clave.existencia }}</td>
              <td class="px-2 py-1 text-right" [ngClass]="{ 'text-red-700 font-bold': unidad.clave.reposicion > 0 }">
                {{ unidad.clave.reposicion }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>